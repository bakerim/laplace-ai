import pandas as pd
import numpy as np
import os
from sklearn.preprocessing import MinMaxScaler
from sklearn.model_selection import train_test_split
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import LSTM, Dense, Dropout

# --- LAPLACE BEYÄ°N MOTORU: LSTM MODELÄ° ---

DATA_FILE = 'laplace_FINAL_TRAINING_SET.csv'
DATA_PATH = os.path.join("laplace_dataset", DATA_FILE)

# Veri setini LSTM iÃ§in uygun hale getirme (Zaman Serisi DÃ¶nÃ¼ÅŸÃ¼mÃ¼)
def create_sequences(data, sequence_length):
    """Veriyi, LSTM'in anlayacaÄŸÄ± N gÃ¼nlÃ¼k serilere dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r."""
    X, y = [], []
    for i in range(len(data) - sequence_length):
        # GeÃ§miÅŸ N gÃ¼nÃ¼n verisi (X)
        X.append(data.iloc[i:(i + sequence_length)].values) 
        # N+1. gÃ¼nÃ¼n hedefi (y)
        y.append(data.iloc[i + sequence_length]['target'])
    return np.array(X), np.array(y)

def build_lstm_model(input_shape):
    """Derin Ã–ÄŸrenme Modelini OluÅŸturur."""
    model = Sequential()
    # 1. Katman: 50 nÃ¶ronlu LSTM (Sequence Ã¶ÄŸrenme)
    model.add(LSTM(units=50, return_sequences=True, input_shape=input_shape))
    model.add(Dropout(0.2)) # AÅŸÄ±rÄ± Ã¶ÄŸrenmeyi engelle
    
    # 2. Katman: 50 nÃ¶ronlu LSTM
    model.add(LSTM(units=50))
    model.add(Dropout(0.2))
    
    # Ã‡Ä±kÄ±ÅŸ KatmanÄ±: Binary tahmin (YÃ¼kselir/DÃ¼ÅŸer)
    model.add(Dense(units=1, activation='sigmoid'))
    
    # Modelin derlenmesi (Binary classification iÃ§in)
    model.compile(optimizer='adam', loss='binary_crossentropy', metrics=['accuracy'])
    return model

def main():
    print("ğŸ“ LAPLACE BEYÄ°N PROTOKOLÃœ BAÅLATILDI.")
    
    if not os.path.exists(DATA_PATH):
        print(f"âŒ HATA: EÄŸitim verisi bulunamadÄ±: {DATA_FILE}")
        print("LÃ¼tfen Ã¶nce laplace_fusion.py'yi Ã§alÄ±ÅŸtÄ±rÄ±n.")
        return

    # Veri YÃ¼kleme ve Temizlik
    df = pd.read_csv(DATA_PATH)
    # Target (Hedef) ve gereksiz sÃ¼tunlarÄ± Ã§Ä±kar
    features = [col for col in df.columns if col not in ['date', 'Date', 'Ticker', 'target']]
    
    # Ã–zellikleri seÃ§
    data = df[features + ['target']]
    
    # Veri Normalizasyonu (LSTM iÃ§in Zorunlu)
    scaler = MinMaxScaler(feature_range=(0, 1))
    scaled_data = scaler.fit_transform(data)
    scaled_df = pd.DataFrame(scaled_data, columns=data.columns)
    
    # LSTM Dizileri OluÅŸturma
    SEQUENCE_LENGTH = 60 # GeÃ§miÅŸ 60 gÃ¼ne bakarak tahmin et
    X, y = create_sequences(scaled_df, SEQUENCE_LENGTH)
    
    # Veriyi eÄŸitim ve test setlerine bÃ¶lme
    X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, shuffle=False)
    
    print(f"âœ… Veri HazÄ±rlÄ±ÄŸÄ± TamamlandÄ±.")
    print(f"   - EÄŸitim Ã–rneÄŸi SayÄ±sÄ±: {len(X_train)}")
    print(f"   - Ã–zellik SayÄ±sÄ±: {X_train.shape[2]}")

    # Modeli OluÅŸturma
    input_shape = (X_train.shape[1], X_train.shape[2])
    model = build_lstm_model(input_shape)
    
    # Modeli EÄŸitme
    print("\n--- YAPAY SÄ°NÄ°R AÄI EÄÄ°TÄ°LÄ°YOR (BU ZAMAN ALACAK) ---")
    
    # Model eÄŸitimi (Epochs: Ã–ÄŸrenme dÃ¶ngÃ¼sÃ¼)
    history = model.fit(X_train, y_train, epochs=10, batch_size=32, validation_data=(X_test, y_test), verbose=1)
    
    # Modeli Kaydetme
    MODEL_NAME = 'laplace_lstm_model.keras'
    model.save(os.path.join(DATA_DIR, MODEL_NAME))
    
    print("\n" + "="*50)
    print(f"ğŸ EÄÄ°TÄ°M TAMAMLANDI!")
    print(f"   - Model BaÅŸarÄ±sÄ± (Test): %{round(history.history['val_accuracy'][-1] * 100, 2)}")
    print(f"   - Model DosyasÄ± Kaydedildi: {MODEL_NAME}")
    print("="*50)


if __name__ == "__main__":
    main()
